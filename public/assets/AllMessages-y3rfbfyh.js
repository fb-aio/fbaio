const __vite__fileDeps=["./MyTable-PaACT2O5.js","./index-DKL-YrvT.js","./index-DfqnkV-X.css","./MyApp-Y2b_WnTf.js","./index-DpS-ZKmI.js","./Table-Boo6dRLL.js","./index-Brz9i-rh.js","./addEventListener-DuKnSXSL.js","./index-CJfoBTLp.js","./PurePanel-ehkeIooI.js","./SearchOutlined-BZ_o7H3N.js","./index-Cu8JyOuX.js","./index-uRB_ns_8.js","./Dropdown-Cf8e-eO5.js","./useBreakpoint-BWvUSJHR.js","./responsiveObserver-C7nvDMAG.js","./Pagination-BFhFQTko.js","./index-Co8SWs3t.js","./EyeOutlined-BCn9PgjA.js","./row-Divw1mQi.js"],__vite__mapDeps=i=>i.map(i=>__vite__fileDeps[i]);
import{aI as _,au as S,av as V,r as k,aA as t,aF as W,aB as p}from"./index-DKL-YrvT.js";import{d as $,u as J,g as Q,t as y,h as M,c as A,T as g,i as Z,b as j,j as ee,o as F,B as ne,k as L}from"./MyApp-Y2b_WnTf.js";import{E as te}from"./ExportButton-CaLr_wgr.js";import{g as ie,a as ae,s as se}from"./messages-BG-RrC4R.js";import{f as oe}from"./file-download-DXINW8zh.js";import{d as le}from"./dayjs.min-DjwBTT_c.js";import{R as E}from"./row-Divw1mQi.js";import{T as re}from"./index-Brz9i-rh.js";import{D as ce}from"./index-uRB_ns_8.js";import{A as f}from"./index-DGXipmN2.js";import{I as G}from"./index-DtCSk6PP.js";import"./responsiveObserver-C7nvDMAG.js";import"./Dropdown-Cf8e-eO5.js";import"./PurePanel-ehkeIooI.js";import"./useBreakpoint-BWvUSJHR.js";import"./index-BIFTeyEY.js";import"./EyeOutlined-BCn9PgjA.js";import"./addEventListener-DuKnSXSL.js";const de=k.lazy(()=>W(()=>import("./MyTable-PaACT2O5.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19]),import.meta.url)),{Title:R}=re,B=l=>{const u=new Set;return l.map(i=>i.isGroup?i.participants.map(m=>({uid:m.id,name:m.name})):{uid:i.id,name:i.name}).flat().forEach(({uid:i,name:m})=>{u.has(i)||u.add({uid:i,name:m})}),Array.from(u.values())};function U(l){return l.name=="-no data-"||l.name=="Người dùng Facebook"}function Me(){const{message:l,notification:u}=$(),{ti:i}=J(),m=_(),h=S(V.profile)??{},[r,H]=Q("AllMessages.data",[]),[w,C]=k.useState(!1);k.useEffect(()=>{r!=null&&r.length||b()},[]);const b=()=>{if(w)return;const e="AllMessages:onClickReload";y(e),l.loading({key:e,duration:0,content:i({en:"Fetching messages...",vi:"Đang tải tin nhắn"})}),C(!0),ie().then(n=>{if(console.log(n),!(n!=null&&n.length))return l.error({key:e,content:i({en:"No data to show",vi:"Không có dữ liệu"})});H(n),l.success({key:e,content:i({en:"Fetch messages completed",vi:"Tải xong tin nhắn"})})}).catch(n=>{l.error({key:e,content:i({en:"Failed to fetch messages",vi:"Lỗi tải tin nhắn"})+": "+n.message}),console.log(n)}).finally(()=>{C(!1)})},P=e=>{console.log(e)},q=e=>()=>{var n,a,s,o;y("AllMessages:onClickFirstMessages"),m("/messages/first",{state:{threadId:e.id||((a=(n=e==null?void 0:e.participants)==null?void 0:n[0])==null?void 0:a.id),threadName:e.name||((o=(s=e==null?void 0:e.participants)==null?void 0:s[0])==null?void 0:o.name)}})},z=async e=>{if(!await L())return;y("AllMessages:onClickDownloadMultipleThreads");for(let a of e)if(await T(a))break},T=async e=>{if(!await L())return;const n="AllMessages:onClickDownloadThread";y(n);const a=e.name,s=n+e.id;l.loading({key:s,duration:0,content:i({en:"Downloading messages...",vi:"Đang tải tin nhắn..."})+a});let o=!1;const d=await ae({threadId:e.id,checkStopFn:()=>o,progressCallback:x=>{l.loading({key:s,duration:0,content:t.jsxs(t.Fragment,{children:[i({en:"Downloading messages... ",vi:"Đang tải tin nhắn... "})+a,t.jsx("br",{}),x.length,i({en:" messages",vi:" tin nhắn"}),t.jsx("br",{}),le(x[0].time).format("YYYY-MM-DD HH:mm:ss"),t.jsx("br",{}),t.jsx("i",{children:i({en:"Click to stop",vi:"Bấm để dừng"})})]}),onClick:()=>{l.loading({key:s,duration:0,content:i({en:"Stopping...",vi:"Đang dừng..."})}),o=!0}})}});l.destroy(s),u.open({type:"success",duration:0,message:i(o?{en:"Download stopped: ",vi:"Đã dừng tải: "}:{en:"Download completed: ",vi:"Tải xong: "})+a,description:d.length+i({en:" messages",vi:" tin nhắn"})});const v=se({threadId:e.id||"",threadName:a,myUid:(h==null?void 0:h.uid)||"",msgs:d});return oe(v,a+".html"),o},Y=(e,n,a)=>{var s,o,d,v,x,D,N,I;return t.jsxs(E,{align:"middle",children:[n.isGroup?t.jsx(ce,{arrow:!0,overlayStyle:{maxHeight:"350px",overflow:"auto",border:"1px dashed gray",borderRadius:"5px"},menu:{items:[{key:"-1",type:"group",label:t.jsx(R,{level:5,style:{textAlign:"center"},children:i({en:`${(s=n.participants)==null?void 0:s.length} members`,vi:`${(o=n.participants)==null?void 0:o.length} thành viên`})})},{type:"divider"},...((v=(d=n.participants)==null?void 0:d.map)==null?void 0:v.call(d,c=>({key:c.id,label:t.jsx("b",{children:c.name}),icon:t.jsx(f,{shape:"square",src:c.avatar}),onClick:()=>window.open(Z(c.id))})))||[]]},children:t.jsx(j,{children:n.image?t.jsx(f,{shape:"square",size:40,src:t.jsx(G,{src:n.image})}):t.jsx(f.Group,{max:{count:5},children:n.participants.filter(c=>c.id!=(h==null?void 0:h.id)).map(c=>t.jsx(f,{src:c.avatar},c.id))})})}):t.jsx(f,{shape:"square",size:40,src:t.jsx(G,{src:n.image||ee((D=(x=n.participants)==null?void 0:x[0])==null?void 0:D.id),fallback:(I=(N=n.participants)==null?void 0:N[0])==null?void 0:I.avatar})}),t.jsx("a",{href:n.url,target:"_blank",style:{marginLeft:"10px"},children:t.jsx("b",{children:n.name})})]})},K=(e,n,a)=>t.jsxs(j.Compact,{children:[t.jsx(g,{title:i({en:"First messages",vi:"Tin nhắn đầu tiên"}),children:t.jsx(p,{type:"primary",icon:t.jsx("i",{className:"fa-solid fa-clock-rotate-left"}),onClick:q(n)})}),t.jsx(g,{title:i({en:"Download messages",vi:"Tải cuộc trò chuyện"}),children:t.jsx(p,{type:"primary",icon:t.jsx("i",{className:"fa-solid fa-download"}),onClick:()=>T(n)})}),t.jsx(g,{title:i({en:"Delete (Coming soon)",vi:"Xoá (Sắp có)"}),children:t.jsx(p,{danger:!0,disabled:!0,icon:t.jsx("i",{className:"fa-solid fa-trash"})})})]}),O=[{title:"#",key:"recent",dataIndex:"recent",sorter:(e,n)=>e.recent-n.recent,render:(e,n,a)=>n.recent+1,width:70,align:"center",headerAlign:"center"},{title:i({en:"Name",vi:"Tên"}),dataIndex:"name",key:"name",sorter:(e,n)=>e.name.localeCompare(n.name),render:Y,filters:[{text:i({en:"Inactive (",vi:"Không hoạt động ("})+r.filter(U).length+")",value:"inactive"}],onFilter:(e,n)=>e=="inactive"?U(n):!0,onSearch:(e,n,a)=>{let s=e.toLowerCase();return a.name.toLocaleLowerCase().includes(s)||a.participants.some(o=>o.name.toLocaleLowerCase().includes(s))},width:"auto"},{title:"Id",dataIndex:"id",key:"id",sorter:(e,n)=>e.id>n.id,onSearch:(e,n,a)=>{let s=e.toLowerCase();return a.id.includes(s)||a.participants.some(o=>o.id.includes(s))},width:150},{title:i({en:"Messages",vi:"Tin nhắn"}),dataIndex:"count",key:"count",sorter:(e,n)=>e.count-n.count,render:(e,n,a)=>M(n.count),width:100,align:"right"},{title:i({en:"Members",vi:"Nguời"}),dataIndex:"participants",key:"participants",sorter:(e,n)=>e.participants.length-n.participants.length,render:(e,n,a)=>M(n.participants.length),width:100,align:"right"},{title:i({en:"Type",vi:"Loại"}),dataIndex:"type",key:"type",render:(e,n,a)=>n.isGroup?i({en:"Group",vi:"Nhóm"}):i({en:"Personal",vi:"Cá nhân"}),filters:[{text:i({en:"Group (",vi:"Nhóm ("})+r.filter(e=>e.isGroup).length+")",value:!0},{text:i({en:"Personal (",vi:"Cá nhân ("})+r.filter(e=>!e.isGroup).length+")",value:!1}],onFilter:(e,n)=>n.isGroup==e,width:100,align:"right"},{title:i({en:"Action",vi:"Hành động"}),dataIndex:"action",key:"download",render:K,width:150,align:"right"}],X=e=>t.jsxs(t.Fragment,{children:[t.jsx(p,{type:"primary",icon:w?t.jsx("i",{className:"fa-solid fa-rotate-right fa-spin"}):t.jsx("i",{className:"fa-solid fa-rotate-right"}),onClick:b,children:i({en:"Reload",vi:"Tải lại"})}),t.jsx(te,{data:e.length?e:r,options:[{key:"uid",label:".txt (uid)",prepareData:n=>({fileName:"messages_uid.txt",data:B(n).map(a=>a.uid).join(`
`)})},{key:"uid_name",label:".csv (uid+name)",prepareData:n=>({fileName:"messages_uid_name.csv",data:F(B(n))})},{key:"json",label:".json",prepareData:n=>({fileName:"messages.json",data:JSON.stringify(n,null,2)})},{key:"csv",label:".csv",prepareData:n=>({fileName:"messages.csv",data:F(n.map(a=>({...a,participants:a.participants.map(s=>s.name).join(", "),participantIds:a.participants.map(s=>s.id).join(", ")})))})}]}),t.jsxs(j.Compact,{children:[t.jsx(g,{title:i({en:"Delete selected (Coming soon)",vi:"Xoá lựa chọn (Sắp có)"}),children:t.jsx(p,{danger:!0,disabled:!0,icon:t.jsx("i",{className:"fa-solid fa-trash-can"}),onClick:()=>P(e),children:i({en:"Delete",vi:"Xoá"})+(e.length?" "+e.length:"")})}),t.jsx(ne,{color:"purple",style:{color:"white"},count:i({en:"New",vi:"Mới"}),children:t.jsx(g,{title:e.length?i({en:"Download "+e.length+" messages",vi:"Tải "+e.length+" cuộc trò chuyện"}):i({en:"Select messages to download",vi:"Chọn cuộc trò chuyện để tải"}),children:t.jsxs(p,{disabled:!(e!=null&&e.length),icon:t.jsx("i",{className:"fa-solid fa-download"}),onClick:()=>z(e),children:[i({en:"Download ",vi:"Tải "})," ",e.length||""]})})})]})]});return t.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%",height:"100%"},children:[t.jsxs(E,{align:"middle",style:{margin:"16px"},children:[t.jsx(R,{level:3,style:{margin:0},children:i({en:"Messages manager",vi:"Quản lý tin nhắn"})}),t.jsx(A,{style:{marginLeft:"10px",fontWeight:"bold",color:"#888"},children:r.length}),t.jsx(g,{title:i({en:'Can only view messages that not have "End to end encryption" (e2ee)',vi:'Chỉ có thể xem tin nhắn không bị "Mã hoá đầu cuối" (e2ee)'}),children:t.jsx(A,{color:"orange",icon:t.jsx("i",{className:"fa-solid fa-lock-open"}),children:" "+i({en:"Only none e2ee",vi:"Không bị mã hoá đầu cuối"})})})]}),t.jsx(de,{data:r,columns:O,size:"small",searchable:!0,selectable:!0,keyExtractor:e=>e==null?void 0:e.id,style:{flex:1,maxHeight:"100%"},renderTitle:X})]})}export{Me as default};
