const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./InfiniteScroll-cu4XHDOd.js","./index-DydTkMV2.js","./index-9SBFHPtm.css","./index-DhNGfTEU.js","./MyApp-BeWNgXar.js"])))=>i.map(i=>d[i]);
import{aO as re,aH as ae,aw as q,ax as Q,r as m,b6 as v,aJ as s,aL as H,aS as oe}from"./index-DydTkMV2.js";import{d as b}from"./dayjs.min-DjwpXSjs.js";import{b as le,c as _,f as J,t as F,h as ce,i as de,S as w,T as k,s as ge,e as E,g as he,d as fe}from"./MyApp-BeWNgXar.js";import{b as A,m as ue,a as me,s as pe,f as xe,c as Y}from"./messages-DjzJbjGq.js";import{f as ve}from"./file-download-BRim8Hre.js";import{V as ye}from"./VideoWithMuted-Bb6r0PlC.js";import{I as we}from"./index-Bb9pHj-Y.js";import{D as je}from"./index-ayc5lMkD.js";import{L as Me}from"./index-BZoZolhB.js";import{A as Fe}from"./index-DIvNmdxF.js";import{T as be}from"./index-CIyDf2jJ.js";import{I as $}from"./index-D7DPDq-n.js";import"./EyeOutlined-1iI3OztS.js";import"./SearchOutlined-BzS9TeDb.js";import"./PurePanel-bZQXf2rU.js";import"./index-CQW_sFN6.js";import"./Pagination-Tj3qyxsl.js";import"./useBreakpoint-BQHjIOgG.js";import"./responsiveObserver-DJIVJZWQ.js";import"./row-8w7dkT51.js";import"./index-BHMCsDY4.js";import"./addEventListener-C_bz9vvg.js";const Ie=m.lazy(()=>oe(()=>import("./InfiniteScroll-cu4XHDOd.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url));function Qe(){var V,z;const{message:i,notification:I}=le(),g=re(),{ti:n}=ae(),f=q(Q.profile),j=((V=g.state)==null?void 0:V.threadId)||"",[c,N]=_("FirstMessages.friendUrlOrUid."+j,j),[r,p]=_("FirstMessages.friendProfile."+c,null),[o,X]=_("FirstMessages.messages."+c,[]),[Z,B]=_("FirstMessages.time."+j,null),[K,U]=m.useState(!1),[T,x]=m.useState({fetchingNext:!1,fetchingPrev:!1,hasNext:!0,hasPrev:!0}),M=(r==null?void 0:r.name)||((z=g.state)==null?void 0:z.threadName)||"";m.useEffect(()=>{c&&O()},[c]),m.useEffect(()=>{var t,e,a;(a=(t=y.current)==null?void 0:t.scrollTo)==null||a.call(t,{top:J("FirstMessages.scrollY",((e=y.current)==null?void 0:e.scrollHeight)||0)})},[]);const C=m.useMemo(()=>{var e,a,l;if(!(o!=null&&o.length))return[];const t=[];for(let h=0;h<o.length;h++){let u=(e=o[h-1])==null?void 0:e.sender,d=(a=o[h])==null?void 0:a.sender,W=(l=o[h+1])==null?void 0:l.sender,D="single";d==u&&d==W?D="middle":d==u?D="end":d==W&&(D="start"),t.push({...o[h],position:D})}return t},[o]),y=m.useRef(null),S=m.useRef(0),R=t=>{var e;S.current=((e=y.current)==null?void 0:e.scrollHeight)||0,console.log(t),X(t),ge("FirstMessages.scrollY",S.current)},L=m.useRef({prev:!1,next:!1});m.useLayoutEffect(()=>{var t,e,a,l;if(L.current.prev&&!T.fetchingPrev){L.current.prev=!1;let h=((t=y.current)==null?void 0:t.scrollHeight)||0;h>S.current&&((e=y.current)==null||e.scrollTo({top:h-S.current}))}P.current&&(P.current=!1,(l=y.current)==null||l.scrollTo({top:((a=y.current)==null?void 0:a.scrollHeight)||0}))},[o,T.fetchingPrev]);const P=m.useRef(!1),O=async()=>{var e,a;if(!((a=(e=c==null?void 0:c.trim)==null?void 0:e.call(c))!=null&&a.length))return i.warning({content:n({en:"Please input friend's url/uid first",vi:"Vui lý nhập uid hoặc link bạn bè trước"})});F("FirstMessages:getRecentMessage");const t="getRecentMessage";try{x(v(d=>{d.hasNext=!1,d.hasPrev=!1}));let l=J("FirstMessages.friendProfile."+c);if(!l){let d;if(/\d+$/.test(c)?d=c:(i.loading({key:t,duration:0,content:n({en:"Fetching friend uid...",vi:"Đang tải uid bạn bè..."})}),d=await ce(c)),!d)throw new Error("Invalid friend url");if(i.loading({key:t,duration:0,content:n({en:"Fetching friend info...",vi:"Đang tải thông tin bạn bè"})}),l=await de(d),!l)throw new Error(n({en:"Failed to fetch friend info",vi:"Không thể tải thông tin bạn bè"}))}p(l),console.log(l),i.loading({key:t,duration:0,content:n({en:"Fetching recent messages...",vi:"Đang tải tin nhắn gần nhất..."})});const h=b();B(h);const u=await A({threadId:l.uid,time:h.valueOf()});R(u),(u==null?void 0:u.length)>0?i.success({key:t,content:n({en:"Fetch completed",vi:"Tải xong"})}):i.info({key:t,content:n({en:"No data to show",vi:"Không có dữ liệu"})}),P.current=!0,x(v(d=>{d.hasNext=u.length>1,d.hasPrev=!0,d.fetchingNext=!1,d.fetchingPrev=!1}))}catch(l){i.error({key:t,content:n({en:"Failed to fetch",vi:"Lỗi tải"})+": "+l.message})}},G=async()=>{if(!await E())return;const t="FirstMessages:downloadAllMessages";F(t);const e=t+(r==null?void 0:r.uid);i.loading({key:e,duration:0,content:n({en:"Downloading messages...",vi:"Đang tải tin nhắn..."})+M});let a=!1;const l=await me({threadId:r==null?void 0:r.uid,checkStopFn:()=>a,progressCallback:u=>{i.loading({key:e,duration:0,content:s.jsxs(s.Fragment,{children:[n({en:"Downloading messages... ",vi:"Đang tải tin nhắn... "})+M,s.jsx("br",{}),u.length,n({en:" messages",vi:" tin nhắn"}),s.jsx("br",{}),b(u[0].time).format("YYYY-MM-DD HH:mm:ss"),s.jsx("br",{}),s.jsx("i",{children:n({en:"Click to stop",vi:"Bấm để dừng"})})]}),onClick:()=>{i.loading({key:e,duration:0,content:n({en:"Stopping...",vi:"Đang dừng..."})}),a=!0}})}});i.destroy(e),I.open({type:"success",duration:0,message:n(a?{en:"Download stopped: ",vi:"Đã dừng tải: "}:{en:"Download completed: ",vi:"Tải xong: "})+M,description:l.length+n({en:" messages",vi:" tin nhắn"})});const h=pe({threadId:(r==null?void 0:r.uid)||"",threadName:M,myUid:(f==null?void 0:f.uid)||"",msgs:l});ve(h,M+".html")},ee=async()=>{if(!(!await E()||!r)){F("FirstMessages:getFirstMessage");try{U(!0);const t=await xe({threadId:r.uid,progress:e=>{B(b(e))}});if(console.log("first message",t),!(t!=null&&t.length))i.info(n({en:"No data to show",vi:"Không có dữ liệu"}));else{let e=await Y({threadId:r.uid,msgId:t[0].id});e!=null&&e.length||(e=await A({threadId:r.uid,time:b(Number(t[0].time)).add(1,"day").valueOf()})),console.log(e),e.length?R(e):i.info(n({en:"No data to show",vi:"Không có dữ liệu"})),x(v(a=>{a.hasNext=!0,a.hasPrev=!0}))}}catch(t){i.error(n({en:"Failed to fetch",vi:"Lỗi tải"})+": "+t.message),console.log(t)}finally{U(!1)}}},te=async t=>{if(!await E()||!r)return;F("FirstMessages:onSelectDate");let e=b(t).valueOf();const a=await A({threadId:r.uid,time:e});console.log(a),R(a),x(v(l=>{l.hasNext=!0,l.hasPrev=!0}))},se=async()=>{var t;if(r){F("FirstMessages:fetchNext");try{x(v(a=>{a.fetchingNext=!0}));const e=await Y({threadId:r.uid,msgId:(t=o==null?void 0:o[o.length-1])==null?void 0:t.id,direction:"down"});console.log(e),e.length>1&&(e.shift(),R([...o,...e])),L.current.next=!0,x(v(a=>{a.hasNext=e.length>1}))}catch(e){i.error(n({en:"Failed to fetch",vi:"Lỗi tải"})+": "+e.message)}finally{x(v(e=>{e.fetchingNext=!1}))}}},ie=async()=>{var t;if(r){F("FirstMessages:fetchPrev");try{x(v(a=>{a.fetchingPrev=!0}));const e=await Y({threadId:r.uid,msgId:(t=o==null?void 0:o[0])==null?void 0:t.id,direction:"up"});e.length>1&&(e.pop(),R([...e,...o])),L.current.prev=!0,x(v(a=>{a.hasPrev=e.length>1}))}catch(e){console.error(e),i.error(n({en:"Failed to fetch",vi:"Lỗi tải"})+": "+e.message)}finally{x(v(e=>{e.fetchingPrev=!1}))}}},ne=()=>C!=null&&C.length?s.jsx(Ie,{prev:ie,next:se,hasPrev:T.hasPrev,hasNext:T.hasNext,loader:s.jsx(w,{style:{display:"flex",justifyContent:"center"},children:s.jsx("i",{className:"fa-solid fa-spinner fa-spin fa-lg"})}),endMessage:s.jsx(w,{style:{display:"flex",justifyContent:"center"},children:n({en:"No more message",vi:"Không còn tin nào"})}),children:s.jsx(Me,{split:!1,dataSource:C,renderItem:t=>s.jsx(ke,{message:t,myProfile:f})})}):null;return s.jsxs(w,{direction:"vertical",style:{width:"100%"},children:[s.jsxs(w,{direction:"horizontal",style:{alignItems:"center"},children:[s.jsx("h1",{style:{margin:0},children:M||n({en:"First messages",vi:"Tin nhắn đầu tiên"})}),(r==null?void 0:r.uid)&&s.jsxs(w.Compact,{children:[s.jsx(k,{title:n({en:"Open in Messenger",vi:"Mở trong Messenger"}),children:s.jsx(H,{icon:s.jsx("i",{className:"fa-solid fa-external-link"}),href:"https://www.facebook.com/messages/t/"+r.uid,target:"_blank"})}),s.jsx(k,{title:n({en:"Download all messages",vi:"Tải xuống tất cả tin nhắn"}),children:s.jsx(H,{icon:s.jsx("i",{className:"fa-solid fa-download"}),onClick:G,disabled:!r})})]}),s.jsxs(w.Compact,{children:[s.jsx(we,{value:c,placeholder:n({en:"Enter friend url/uid",vi:"Nhập url/uid của bạn bè"}),onChange:t=>N(t.target.value)}),s.jsx(H,{type:"primary",onClick:O,loading:K,children:s.jsx("i",{className:"fas fa-search"})})]}),s.jsxs(w.Compact,{children:[s.jsx(k,{title:n({en:"Choose any date to view messages in that day",vi:"Chọn ngày bất kỳ để xem tin nhắn trong ngày đó"}),children:s.jsx(je,{showTime:!0,value:Z,minDate:ue,onChange:(t,e)=>{console.log("Selected Time: ",t),console.log("Formatted Selected Time: ",e),B(t)},onOk:te,disabled:!r,placeholder:n({en:"Select time",vi:"Chọn thời gian"})})}),s.jsx(k,{title:n({en:"Find first message",vi:"Tìm tin nhắn đầu tiên"}),children:s.jsx(H,{type:"primary",onClick:ee,loading:K,disabled:!r,children:s.jsx("i",{className:"fa-solid fa-clock-rotate-left"})})})]})]}),s.jsx(w,{ref:y,direction:"vertical",size:3,style:{width:"100%",maxHeight:"70vh",overflow:"auto",padding:12},children:ne()})]})}function Re(i,I){let g=4;if(I){if(i==="start")return{borderBottomRightRadius:g};if(i==="middle")return{borderBottomRightRadius:g,borderTopRightRadius:g};if(i==="end")return{borderTopRightRadius:g}}else{if(i==="start")return{borderBottomLeftRadius:g};if(i==="middle")return{borderBottomLeftRadius:g,borderTopLeftRadius:g};if(i==="end")return{borderTopLeftRadius:g}}return{}}function ke({message:i,myProfile:I}){var r;const g=q(Q.darkMode),n=i.position,f=i.sender===I.uid,j={display:"block",wordBreak:"break-word",padding:"8px 12px",backgroundColor:f?"#0184ff":g?"#303030":"#f0f0f0",color:g||f?"#eee":"#111",whiteSpace:"pre-line",margin:0,maxWidth:400,borderTopLeftRadius:24,borderTopRightRadius:24,borderBottomLeftRadius:24,borderBottomRightRadius:24,...Re(n,f)},c=n==="end"||n==="single",N=s.jsx("div",{style:{flex:1}});return s.jsxs("div",{style:{display:"flex",alignItems:"center",width:"100%",marginBottom:c?12:2},children:[f?N:c?s.jsx("a",{href:he(i.sender),target:"_blank",children:s.jsx(Fe,{shape:"circle",size:40,src:fe(i.sender),style:{marginRight:8}})}):s.jsx("div",{style:{width:48}}),s.jsxs(k,{title:b(i.time).format("YYYY-MM-DD HH:mm"),placement:f?"left":"right",children:[i.text&&s.jsx(be.Paragraph,{style:j,children:i.text}),i.sticker&&s.jsx($,{width:150,src:i.sticker}),(r=i.attachments)==null?void 0:r.map((p,o)=>p.type==="video"?s.jsx(ye,{src:p.uri,style:{maxHeight:300,maxWidth:300}},"attachment"+o):p.type==="image"||p.type==="gif"?s.jsx($,{src:p.uri,style:{maxHeight:300,maxWidth:300}},"attachment"+o):p.type==="file"?s.jsxs("a",{href:p.uri,target:"_blank",rel:"noreferrer",style:j,children:["File: ",p.filename]},"attachment"+o):null)]}),!f&&N]})}export{Qe as default};
